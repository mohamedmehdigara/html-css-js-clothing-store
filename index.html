<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Threads - Modern Apparel</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom font import and application */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            font-family: 'Inter', sans-serif;
        }

        /* Utility class for the sticky header shadow */
        .header-scrolled {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* Modal backdrop styling */
        #cart-modal-backdrop, #wishlist-modal-backdrop, #quickview-modal-backdrop, #compare-modal-backdrop {
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            z-index: 50; 
        }
        
        /* Cart Modal (Right side) */
        #cart-modal { transform: translateX(100%); }
        .show-cart #cart-modal-backdrop { opacity: 1; pointer-events: auto; }
        .show-cart #cart-modal { transform: translateX(0); }

        /* Wishlist Modal (Left side) */
        #wishlist-modal { transform: translateX(-100%); }
        .show-wishlist #wishlist-modal-backdrop { opacity: 1; pointer-events: auto; }
        .show-wishlist #wishlist-modal { transform: translateX(0); }

        /* Quick View Modal styling */
        .show-quickview #quickview-modal-backdrop { opacity: 1; pointer-events: auto; }
        .show-quickview #quickview-modal { transform: scale(1); opacity: 1; }

        /* Compare Modal styling */
        .show-compare #compare-modal-backdrop { opacity: 1; pointer-events: auto; }
        .show-compare #compare-modal { transform: translateY(0); opacity: 1; }

        /* Custom scrollbar styling for the product grid on smaller screens */
        @media (max-width: 768px) {
            #product-grid {
                overflow-x: auto;
                scroll-snap-type: x mandatory;
            }
            .product-card {
                scroll-snap-align: start;
                flex: 0 0 80%;
                margin-right: 1rem;
            }
        }
        
        /* Review Star Rating System CSS for reliable interaction */
        .rating-container {
            display: inline-flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
        }
        .rating-container input {
            display: none;
        }
        .rating-container label {
            color: #D1D5DB; /* gray-300 */
            cursor: pointer;
            transition: color 0.2s;
            font-size: 24px;
            line-height: 1;
        }
        /* Color the star and all stars before it on hover */
        .rating-container label:hover,
        .rating-container label:hover ~ label {
            color: #FBBF24; /* yellow-500 */
        }
        /* Color the star and all stars before it when checked */
        .rating-container input:checked ~ label {
            color: #FBBF24;
        }

        /* Toast Notifications Container */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease, transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-width: 250px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            font-weight: 500;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        /* NEW: Magnifier Lens Styling */
        #magnifier-lens {
            pointer-events: none;
            position: absolute;
            border: 4px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            border-radius: 50%; /* Circular lens */
            overflow: hidden;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.2s;
            background-repeat: no-repeat;
        }
    </style>
</head>
<!-- Apply dark class dynamically to enable dark mode -->
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-500" id="body-container">

    <!-- Header & Navigation -->
    <header id="main-header" class="sticky top-0 z-40 bg-white dark:bg-gray-800 transition duration-300">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <a href="#" class="text-3xl font-extrabold text-indigo-700 tracking-tight">
                Stellar Threads
            </a>
            
            <!-- Action Buttons -->
            <div class="flex space-x-3 items-center">
                
                <!-- Dark Mode Toggle -->
                <button id="dark-mode-toggle" onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150">
                    <i id="dark-mode-icon" data-lucide="moon" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
                </button>

                <!-- Product Comparison Button -->
                <button id="compare-button" onclick="toggleComparisonModal()" class="relative p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150">
                    <span id="compare-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-yellow-500 rounded-full opacity-0 transition-opacity duration-300">0</span>
                    <i data-lucide="scale" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
                </button>
                
                <!-- Wishlist Button -->
                <button id="wishlist-button" onclick="toggleWishlistModal()" class="relative p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150">
                    <span id="wishlist-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full opacity-0 transition-opacity duration-300">0</span>
                    <i data-lucide="heart" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
                </button>

                <!-- Cart Button -->
                <button id="cart-button" onclick="toggleCart()" class="relative p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150">
                    <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full opacity-0 transition-opacity duration-300">0</span>
                    <i data-lucide="shopping-cart" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content: Hero Section -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 mt-12 mb-20">
        <section class="text-center mb-16 p-8 bg-indigo-50 dark:bg-indigo-900 rounded-2xl shadow-lg transition-colors duration-500">
            <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 dark:text-white mb-4 tracking-tight">
                New Arrivals: Cosmic Comfort
            </h1>
            <p class="text-xl text-gray-600 dark:text-gray-300 max-w-2xl mx-auto mb-6">
                Explore our latest collection of sustainable and ultra-soft essentials, designed for your journey.
            </p>
            <button class="bg-indigo-600 text-white px-8 py-3 rounded-xl text-lg font-semibold shadow-xl hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                Shop the Collection
            </button>
        </section>

        <!-- Product Listing Header and Controls -->
        <div class="flex flex-col gap-4 mb-8">
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Featured Products</h2>
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <!-- Search Bar -->
                <div class="relative w-full sm:w-1/3">
                    <input type="text" id="product-search" oninput="applyFilters()" placeholder="Search products..." class="w-full p-2 pl-10 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                </div>
                
                <div class="flex space-x-4 w-full sm:w-auto">
                    <!-- Category Filter -->
                    <select id="category-filter" onchange="applyFilters()" class="p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500 w-1/2 sm:w-auto">
                        <option value="all">All Categories</option>
                        <option value="T-Shirts">T-Shirts</option>
                        <option value="Hoodies">Hoodies</option>
                        <option value="Jeans">Jeans</option>
                        <option value="Shirts">Shirts</option>
                        <option value="Bottoms">Bottoms</option>
                        <option value="Sweaters">Sweaters</option>
                    </select>
                    
                    <!-- Sort By -->
                    <select id="sort-by" onchange="applyFilters()" class="p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500 w-1/2 sm:w-auto">
                        <option value="default">Sort: Default</option>
                        <option value="low-high">Price: Low to High</option>
                        <option value="high-low">Price: High to Low</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Product Grid -->
        <section id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 md:gap-8 pb-4">
            <!-- Product cards will be injected here by JavaScript -->
        </section>

        <!-- Recently Viewed Products Section -->
        <section id="recently-viewed-section" class="mt-20 hidden">
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-6 border-b pb-2 border-gray-200 dark:border-gray-700">
                Recently Viewed
            </h2>
            <div id="recently-viewed-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                <!-- Recently viewed cards will be injected here -->
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-12">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                <!-- Column 1: Brand Info -->
                <div>
                    <h4 class="text-xl font-bold mb-4 text-indigo-400">Stellar Threads</h4>
                    <p class="text-sm text-gray-400">Sustainable style for the modern explorer.</p>
                </div>
                <!-- Column 2: Quick Links -->
                <div>
                    <h4 class="font-semibold mb-4 border-b border-indigo-700 pb-1">Quick Links</h4>
                    <ul class="space-y-2 text-sm text-gray-300">
                        <li><a href="#" class="hover:text-indigo-400 transition">About Us</a></li>
                        <li><a href="#" class="hover:text-indigo-400 transition">Shipping & Returns</a></li>
                        <li><a href="#" class="hover:text-indigo-400 transition">Size Guide</a></li>
                    </ul>
                </div>
                <!-- Column 3: Newsletter Sign-up Simulation -->
                <div class="col-span-2 md:col-span-1">
                    <h4 class="font-semibold mb-4 border-b border-indigo-700 pb-1">Get 15% Off</h4>
                    <p class="text-sm text-gray-300 mb-3">Sign up for exclusive offers and updates.</p>
                    <div class="flex flex-col space-y-2">
                        <input type="email" id="newsletter-email" placeholder="Your email address" class="p-3 rounded-lg text-gray-900 focus:ring-indigo-500 focus:border-indigo-500">
                        <button onclick="simulateNewsletterSignup()" class="bg-indigo-600 text-white p-3 rounded-lg font-medium hover:bg-indigo-700 transition shadow-md">
                            Subscribe
                        </button>
                    </div>
                    <p id="newsletter-message" class="text-sm mt-2 font-medium"></p>
                </div>
                <!-- Column 4: Contact -->
                <div>
                    <h4 class="font-semibold mb-4 border-b border-indigo-700 pb-1">Connect</h4>
                    <p class="text-sm text-gray-400">Email: info@stellarthreads.com</p>
                    <div class="flex space-x-3 mt-3">
                        <i data-lucide="instagram" class="w-5 h-5 cursor-pointer hover:text-indigo-400 transition"></i>
                        <i data-lucide="facebook" class="w-5 h-5 cursor-pointer hover:text-indigo-400 transition"></i>
                        <i data-lucide="twitter" class="w-5 h-5 cursor-pointer hover:text-indigo-400 transition"></i>
                    </div>
                </div>
            </div>
            <div class="mt-8 pt-6 border-t border-gray-800 text-center text-sm text-gray-500">
                &copy; 2025 Stellar Threads. All rights reserved.
            </div>
        </div>
    </footer>
    
    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Wishlist Modal (Left Side) -->
    <div id="wishlist-modal-backdrop" onclick="toggleWishlistModal()" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm opacity-0 hidden transition duration-300">
        <div id="wishlist-modal" onclick="event.stopPropagation()" class="fixed top-0 left-0 w-full md:w-96 h-full bg-white dark:bg-gray-800 shadow-2xl transform transition duration-500 ease-in-out">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Your Wishlist</h3>
                <button onclick="toggleWishlistModal()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <i data-lucide="x" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
                </button>
            </div>
            <div id="wishlist-items-container" class="h-full overflow-y-auto max-h-[calc(100vh-80px)] p-6 space-y-4">
                <p id="empty-wishlist-message" class="text-gray-500 text-center py-10">Your wishlist is empty. Save items you love!</p>
            </div>
        </div>
    </div>


    <!-- Shopping Cart Modal (Right Side) -->
    <div id="cart-modal-backdrop" onclick="toggleCart()" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm opacity-0 hidden transition duration-300">
        <div id="cart-modal" onclick="event.stopPropagation()" class="fixed top-0 right-0 w-full md:w-96 h-full bg-white dark:bg-gray-800 shadow-2xl transform transition duration-500 ease-in-out">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Your Cart</h3>
                <button onclick="toggleCart()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <i data-lucide="x" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
                </button>
            </div>
            <div id="cart-items-container" class="h-auto overflow-y-auto max-h-[calc(100vh-350px)] p-6 space-y-4">
                <p id="empty-cart-message" class="text-gray-500 text-center py-10">Your cart is empty. Start shopping!</p>
            </div>
            <div class="p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700">
                <label for="coupon-code" class="text-sm font-semibold text-gray-700 dark:text-gray-200 block mb-2">Have a Coupon Code?</label>
                <div class="flex space-x-2">
                    <input type="text" id="coupon-code" placeholder="e.g. GEMINI20" class="flex-grow p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="apply-coupon-btn" onclick="applyCoupon()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition shadow-md">Apply</button>
                </div>
                <p id="coupon-message" class="text-sm mt-2 font-medium"></p>
            </div>
            <div class="absolute bottom-0 w-full p-6 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                <div id="cart-summary-totals">
                    <!-- Totals (Subtotal, Discount, Total) will be injected here by JS -->
                </div>
                <button onclick="checkout()" class="w-full bg-green-600 text-white px-6 py-3 rounded-xl text-lg font-semibold hover:bg-green-700 transition duration-300 shadow-lg mt-4">
                    Proceed to Checkout
                </button>
            </div>

        </div>
    </div>

    <!-- Quick View Modal -->
    <div id="quickview-modal-backdrop" onclick="closeQuickView()" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm opacity-0 hidden transition duration-300 flex items-center justify-center p-4">
        <div id="quickview-modal" onclick="event.stopPropagation()" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[95vh] overflow-y-auto transform scale-90 opacity-0 transition duration-300 ease-in-out">
            <!-- Modal content will be injected here by openQuickView() -->
        </div>
    </div>
    
    <!-- Product Comparison Modal (NEW) -->
    <div id="compare-modal-backdrop" onclick="closeComparisonModal()" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm opacity-0 hidden transition duration-300 flex items-center justify-center p-4">
        <div id="compare-modal" onclick="event.stopPropagation()" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-6xl max-h-[95vh] overflow-y-auto transform scale-90 opacity-0 transition duration-300 ease-in-out">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4 border-b pb-3 dark:border-gray-700">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Product Comparison (<span id="compare-count-modal">0</span> / 3)</h3>
                    <button onclick="closeComparisonModal()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                        <i data-lucide="x" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
                    </button>
                </div>
                <div id="compare-items-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Comparison items will be injected here -->
                </div>
                <div class="mt-6 pt-4 border-t dark:border-gray-700 flex justify-end">
                    <button onclick="clearComparison()" class="bg-red-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-600 transition shadow-md">
                        Clear All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for Store Logic -->
    <script>
        // Store Product Data - Added sizes, colors, stock, and tags
        const PRODUCTS = [
            { id: 1, name: "The Classic Tee (Navy)", price: 29.99, rating: 4.8, reviewsCount: 94, category: "T-Shirts", 
              image: "https://placehold.co/600x600/3B82F6/FFFFFF?text=Navy+Tee+FRONT", 
              gallery: ["https://placehold.co/600x600/3B82F6/FFFFFF?text=Navy+Tee+FRONT", "https://placehold.co/600x600/2563EB/FFFFFF?text=Navy+Tee+BACK", "https://placehold.co/600x600/1D4ED8/FFFFFF?text=Navy+Tee+DETAIL"],
              sizes: ['S', 'M', 'L', 'XL'], colors: ['Navy (Blue)', 'White', 'Black'], stock: 15, tags: ['Best Seller'] },
            { id: 2, name: "Urban Explorer Hoodie", price: 59.99, rating: 4.5, reviewsCount: 42, category: "Hoodies", 
              image: "https://placehold.co/600x600/4B5563/FFFFFF?text=Grey+Hoodie+FRONT", 
              gallery: ["https://placehold.co/600x600/4B5563/FFFFFF?text=Grey+Hoodie+FRONT", "https://placehold.co/600x600/374151/FFFFFF?text=Grey+Hoodie+HOOD", "https://placehold.co/600x600/1F2937/FFFFFF?text=Grey+Hoodie+POCKET"],
              sizes: ['XS', 'S', 'M', 'L'], colors: ['Heather Grey', 'Charcoal', 'Forest Green'], stock: 3, tags: [] },
            { id: 3, name: "Essential Denim (Slim Fit)", price: 79.99, rating: 4.2, reviewsCount: 120, category: "Jeans", 
              image: "https://placehold.co/600x600/10B981/FFFFFF?text=Denim+Jeans", 
              sizes: ['28/30', '30/32', '32/32', '34/34'], colors: ['Dark Wash', 'Light Wash'], stock: 40, tags: ['New'] },
            { id: 4, name: "Plaid Overshirt (Autumn)", price: 49.99, rating: 4.9, reviewsCount: 55, category: "Shirts", 
              image: "https://placehold.co/600x600/F59E0B/FFFFFF?text=Plaid+Shirt", 
              sizes: ['S', 'M', 'L'], colors: ['Red Plaid', 'Blue Plaid'], stock: 0, tags: [] },
            { id: 5, name: "Aero Joggers", price: 64.99, rating: 3.9, reviewsCount: 30, category: "Bottoms", 
              image: "https://placehold.co/600x600/8B5CF6/FFFFFF?text=Purple+Joggers", 
              sizes: ['M', 'L', 'XL'], colors: ['Midnight Purple', 'Black'], stock: 8, tags: [] },
            { id: 6, name: "Minimalist Sweater", price: 54.99, rating: 4.7, reviewsCount: 78, category: "Sweaters", 
              image: "https://placehold.co/600x600/EF4444/FFFFFF?text=Red+Sweater", 
              sizes: ['S', 'M', 'L', 'XL'], colors: ['Crimson Red', 'Oatmeal Beige'], stock: 1, tags: ['Low Stock'] },
        ];
        
        // Available Coupon Codes
        const VALID_COUPONS = {
            'GEMINI20': 0.20, 
            'SAVE10': 0.10,   
            'NEWUSER': 0.15,  
        };

        // Global State (persisted with localStorage)
        // Cart item structure now includes 'size' and 'color'
        let cart = JSON.parse(localStorage.getItem('stellarThreadsCart')) || [];
        let wishlist = JSON.parse(localStorage.getItem('stellarThreadsWishlist')) || [];
        let recentlyViewedIds = JSON.parse(localStorage.getItem('recentlyViewedIds')) || []; 
        let productsToCompareIds = JSON.parse(localStorage.getItem('productsToCompareIds')) || []; 
        let priceTrackedIds = JSON.parse(localStorage.getItem('priceTrackedIds')) || [];

        // Global State (session only)
        let appliedCoupon = { code: null, discountPercentage: 0, message: '' }; 
        let displayedProducts = [...PRODUCTS]; 
        // Simulated reviews storage, just for the session.
        let sessionReviews = {}; 

        const MAX_RECENTLY_VIEWED = 5;
        const MAX_COMPARE = 3;

        // --- Core Utility Functions ---

        /**
         * Finds a product by its ID.
         * @param {number} id - The product ID.
         * @returns {object | undefined} The product object.
         */
        function getProductById(id) {
            return PRODUCTS.find(p => p.id === id);
        }
        
        /**
         * Checks if a product is in the wishlist.
         * @param {number} id - The product ID.
         * @returns {boolean} True if in wishlist.
         */
        function checkIfInWishlist(id) {
            return wishlist.some(item => item.id === id);
        }

        /**
         * Checks if a product is currently selected for comparison.
         * @param {number} id - The product ID.
         * @returns {boolean} True if in comparison list.
         */
        function checkIfInComparison(id) {
            return productsToCompareIds.includes(id);
        }

        /**
         * Generates star icons HTML based on a rating value.
         * @param {number} rating - The rating value (0-5).
         * @returns {string} HTML string of Lucide star icons.
         */
        function generateRatingStars(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.25 && rating % 1 <= 0.75; 
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
            
            let starsHtml = '';

            for (let i = 0; i < fullStars; i++) {
                starsHtml += '<i data-lucide="star" class="w-4 h-4 fill-yellow-500 text-yellow-500"></i>';
            }
            if (halfStar) {
                starsHtml += '<i data-lucide="star-half" class="w-4 h-4 fill-yellow-500 text-yellow-500"></i>';
            }
            for (let i = 0; i < emptyStars; i++) {
                starsHtml += '<i data-lucide="star" class="w-4 h-4 text-gray-300 dark:text-gray-600"></i>';
            }

            return starsHtml;
        }

        /**
         * Displays a transient toast notification on the top right.
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error' for styling.
         */
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let bgColor = '';
            let iconHtml = '';

            if (type === 'success') {
                bgColor = 'bg-green-600';
                iconHtml = '<i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>';
            } else if (type === 'error') {
                bgColor = 'bg-red-600';
                iconHtml = '<i data-lucide="x-octagon" class="w-5 h-5 mr-2"></i>';
            } else if (type === 'info') {
                bgColor = 'bg-indigo-600';
                iconHtml = '<i data-lucide="info" class="w-5 h-5 mr-2"></i>';
            }

            toast.className = `toast ${bgColor} flex items-center`;
            toast.innerHTML = `${iconHtml}<span>${message}</span>`;
            
            container.appendChild(toast);
            lucide.createIcons();

            // Show and then hide after a delay
            setTimeout(() => {
                toast.classList.add('show');
            }, 50);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(toast);
                }, 400); // Wait for transition to finish
            }, 3000); // Display duration
        }


        // --- State Management ---

        function updateCartState() {
            localStorage.setItem('stellarThreadsCart', JSON.stringify(cart));
            renderCart();
            updateCartCount();
        }

        function updateWishlistState() { 
            localStorage.setItem('stellarThreadsWishlist', JSON.stringify(wishlist));
            renderWishlist();
            updateWishlistCount();
            renderProducts(); 
        }

        function updateCompareState() {
            localStorage.setItem('productsToCompareIds', JSON.stringify(productsToCompareIds));
            updateCompareCount();
            renderProducts(); // Update the compare buttons on the grid
        }
        
        function updatePriceTrackedState() {
            localStorage.setItem('priceTrackedIds', JSON.stringify(priceTrackedIds));
        }

        /**
         * Adds a product ID to the recently viewed list.
         * @param {number} id - The product ID.
         */
        function addRecentlyViewed(id) {
            recentlyViewedIds = recentlyViewedIds.filter(itemId => itemId !== id);
            recentlyViewedIds.unshift(id);
            if (recentlyViewedIds.length > MAX_RECENTLY_VIEWED) {
                recentlyViewedIds = recentlyViewedIds.slice(0, MAX_RECENTLY_VIEWED);
            }

            localStorage.setItem('recentlyViewedIds', JSON.stringify(recentlyViewedIds));
            renderRecentlyViewed();
        }


        // --- Cart & Wishlist Logic ---

        function toggleWishlist(id) {
            const index = wishlist.findIndex(item => item.id === id);
            
            if (index > -1) {
                wishlist.splice(index, 1);
                showToast('Item removed from Wishlist.', 'error');
            } else {
                wishlist.push({ id });
                showToast('Item added to Wishlist!', 'success');
            }
            updateWishlistState();
        }

        function moveToCart(id) {
            const product = getProductById(id);
            if (!product) return;

            // When moving from wishlist, just use the first available size/color options
            const size = product.sizes?.[0] || 'N/A';
            const color = product.colors?.[0] || 'Default';
            
            addToCart(id, 1, size, color);
            
            wishlist = wishlist.filter(item => item.id !== id);
            updateWishlistState();
            toggleCart();
            showToast(`Moved ${product.name} to Cart.`, 'info');
        }

        function toggleWishlistModal() {
            const modalBackdrop = document.getElementById('wishlist-modal-backdrop');
            const body = document.getElementById('body-container');

            if (body.classList.contains('show-cart')) toggleCart();
            if (body.classList.contains('show-quickview')) closeQuickView();
            if (body.classList.contains('show-compare')) closeComparisonModal();
            
            if (modalBackdrop.classList.contains('hidden')) {
                modalBackdrop.classList.remove('hidden');
                setTimeout(() => {
                    body.classList.add('show-wishlist');
                    body.classList.add('overflow-hidden');
                }, 10);
            } else {
                body.classList.remove('show-wishlist');
                body.classList.remove('overflow-hidden');
                setTimeout(() => {
                    modalBackdrop.classList.add('hidden');
                }, 500);
            }
        }

        /**
         * Adds a product to the cart with size and color options.
         * @param {number} id 
         * @param {number} quantity 
         * @param {string} size 
         * @param {string} color 
         */
        function addToCart(id, quantity = 1, size = 'N/A', color = 'Default') {
            const product = getProductById(id);
            if (!product) return;

            const existingItem = cart.find(item => item.id === id && item.size === size && item.color === color);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                // Generate a unique item ID for the cart (important for options)
                const cartItemId = `${id}-${size}-${color}-${Date.now()}`;
                cart.push({ id, cartItemId, quantity, size, color });
            }
            updateCartState();
            showToast(`${product.name} (${size}, ${color}) added to cart!`, 'success');
        }

        function changeQuantity(cartItemId, change) {
            const existingItem = cart.find(item => item.cartItemId === cartItemId);
            
            if (existingItem) {
                existingItem.quantity += change;
                if (existingItem.quantity <= 0) {
                    removeFromCart(cartItemId);
                }
            }
            updateCartState();
        }

        function removeFromCart(cartItemId) {
            cart = cart.filter(item => item.cartItemId !== cartItemId);
            updateCartState();
        }

        function checkout() {
            if (cart.length === 0) {
                showToast('Cart is empty. Please add items to checkout.', 'error');
                return;
            }
            
            cart = []; 
            appliedCoupon = { code: null, discountPercentage: 0, message: '' };
            updateCartState();
            
            toggleCart();
            showToast('Checkout simulated. Order placed successfully!', 'success');
        }

        function applyCoupon() {
            const codeInput = document.getElementById('coupon-code');
            const code = codeInput.value.toUpperCase().trim();
            
            if (VALID_COUPONS[code]) {
                appliedCoupon = { 
                    code: code, 
                    discountPercentage: VALID_COUPONS[code], 
                    message: `Success! ${code} applied for ${VALID_COUPONS[code] * 100}% off.`
                };
                showToast(`Coupon ${code} applied.`, 'success');
            } else {
                appliedCoupon = { 
                    code: null, 
                    discountPercentage: 0, 
                    message: `Coupon code "${code}" is invalid or expired.`
                };
                showToast(`Invalid coupon code: ${code}`, 'error');
            }
            renderCart(); 
        }

        function removeCoupon() {
             appliedCoupon = { code: null, discountPercentage: 0, message: 'Coupon removed.' };
             document.getElementById('coupon-code').value = '';
             renderCart();
             showToast('Coupon removed.', 'info');
        }
        
        // --- Comparison Logic (NEW) ---

        /**
         * Adds or removes a product from the comparison list.
         * @param {number} id - The product ID.
         */
        function toggleComparison(id) {
            const index = productsToCompareIds.indexOf(id);
            const product = getProductById(id);

            if (index > -1) {
                // Remove
                productsToCompareIds.splice(index, 1);
                showToast(`${product.name} removed from comparison.`, 'info');
            } else {
                // Add, only if limit not reached
                if (productsToCompareIds.length < MAX_COMPARE) {
                    productsToCompareIds.push(id);
                    showToast(`${product.name} added to comparison! (${productsToCompareIds.length}/${MAX_COMPARE})`, 'success');
                } else {
                    showToast(`Comparison limit reached (${MAX_COMPARE} items).`, 'error');
                }
            }
            updateCompareState();
        }
        
        function clearComparison() {
            productsToCompareIds = [];
            updateCompareState();
            renderComparisonModal();
            showToast('Comparison list cleared.', 'info');
        }

        function toggleComparisonModal() {
            const modalBackdrop = document.getElementById('compare-modal-backdrop');
            const body = document.getElementById('body-container');

            if (body.classList.contains('show-cart')) toggleCart();
            if (body.classList.contains('show-wishlist')) toggleWishlistModal();
            if (body.classList.contains('show-quickview')) closeQuickView();

            if (modalBackdrop.classList.contains('hidden')) {
                renderComparisonModal(); // Render before showing
                modalBackdrop.classList.remove('hidden');
                setTimeout(() => {
                    body.classList.add('show-compare');
                    body.classList.add('overflow-hidden');
                }, 10);
            } else {
                body.classList.remove('show-compare');
                body.classList.remove('overflow-hidden');
                setTimeout(() => {
                    modalBackdrop.classList.add('hidden');
                }, 500);
            }
        }
        
        function closeComparisonModal() {
             const body = document.getElementById('body-container');
            
            body.classList.remove('show-compare');
            body.classList.remove('overflow-hidden');

            setTimeout(() => {
                document.getElementById('compare-modal-backdrop').classList.add('hidden');
            }, 300); 
        }
        
        // --- Filtering and Sorting Logic ---

        function applyFilters() {
            const searchQuery = document.getElementById('product-search').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            const sortBy = document.getElementById('sort-by').value;

            let filtered = PRODUCTS.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchQuery);
                const matchesCategory = categoryFilter === 'all' || product.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });

            // Sorting logic
            if (sortBy === 'low-high') {
                filtered.sort((a, b) => a.price - b.price);
            } else if (sortBy === 'high-low') {
                filtered.sort((a, b) => b.price - a.price);
            }
            
            displayedProducts = filtered;
            renderProducts();
        }
        
        // --- UI Rendering Functions ---

        /**
         * Renders the product cards onto the main page.
         */
        function renderProducts() {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = ''; 

            if (displayedProducts.length === 0) {
                 grid.innerHTML = '<p class="col-span-full text-center py-10 text-xl text-gray-500 dark:text-gray-400">No products match your current search and filter criteria.</p>';
                 return;
            }

            displayedProducts.forEach(product => {
                const isWished = checkIfInWishlist(product.id);
                const isCompared = checkIfInComparison(product.id);
                const heartColor = isWished ? 'fill-red-500 text-red-500' : 'text-gray-500';
                const scaleColor = isCompared ? 'fill-yellow-500 text-yellow-500' : 'text-gray-500';
                const ratingStars = generateRatingStars(product.rating);
                
                // NEW: Badges/Tags (Combines Category with other tags and Low Stock status)
                let tags = []; 
                if (product.tags) { tags = tags.concat(product.tags); }
                // Auto-add 'Low Stock' badge if stock is low
                if (product.stock > 0 && product.stock < 5 && !tags.includes('Low Stock')) {
                     tags.push('Low Stock');
                }
                
                // Ensure category is displayed first
                tags.unshift(product.category);

                // Filter out duplicates and format HTML
                const uniqueTags = [...new Set(tags)];
                let badgesHtml = uniqueTags.map(tag => {
                    let tagClass = 'bg-indigo-600 text-white';
                    if (tag === 'Low Stock') tagClass = 'bg-red-500 text-white';
                    if (tag === 'New') tagClass = 'bg-green-500 text-white';
                    if (tag === 'Best Seller') tagClass = 'bg-yellow-500 text-gray-900';
                    if (tag === product.category) tagClass = 'bg-gray-900 text-white dark:bg-gray-200 dark:text-gray-900'; // Category badge style
                    
                    return `<span class="text-xs font-medium ${tagClass} px-2 py-1 rounded-full mr-1 mb-1">${tag}</span>`;
                }).join('');


                const productCard = `
                    <div class="product-card bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition duration-300 transform hover:-translate-y-1 flex flex-col justify-between border border-gray-100 dark:border-gray-700">
                        <div class="relative overflow-hidden">
                            <img src="${product.image}" alt="${product.name}" class="w-full h-auto object-cover transition duration-500 hover:scale-105" onerror="this.onerror=null; this.src='https://placehold.co/600x600/E5E7EB/4B5563?text=Image+Missing';">
                            
                            <!-- Product Badges (Category, New, Low Stock, etc.) -->
                            <div class="absolute top-2 left-2 flex flex-wrap max-w-[80%]">
                                ${badgesHtml}
                            </div>
                            
                            <!-- Wishlist Toggle Button -->
                            <button onclick="toggleWishlist(${product.id})" class="absolute top-2 right-10 p-2 rounded-full bg-white dark:bg-gray-900/80 backdrop-blur-sm hover:bg-red-100 dark:hover:bg-red-900/50 transition shadow-md">
                                <i data-lucide="heart" class="w-5 h-5 ${heartColor}"></i>
                            </button>
                            
                            <!-- Comparison Toggle Button -->
                            <button onclick="toggleComparison(${product.id})" class="absolute top-2 right-2 p-2 rounded-full bg-white dark:bg-gray-900/80 backdrop-blur-sm hover:bg-yellow-100 dark:hover:bg-yellow-900/50 transition shadow-md">
                                <i data-lucide="scale" class="w-5 h-5 ${scaleColor}"></i>
                            </button>

                        </div>
                        <div class="p-4 flex flex-col flex-grow">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-1">${product.name}</h3>
                            <div class="flex items-center space-x-2 mb-2">
                                <div class="flex">${ratingStars}</div>
                                <span class="text-xs text-gray-500 dark:text-gray-400">(${product.reviewsCount})</span>
                            </div>
                            <p class="text-2xl font-bold text-indigo-600 mb-3">$${product.price.toFixed(2)}</p>
                            
                            <!-- Buttons -->
                            <div class="mt-auto">
                                <button onclick="openQuickView(${product.id})" 
                                    class="w-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 p-3 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-200 flex items-center justify-center space-x-1 shadow-sm text-sm">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                    <span>Quick View</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                grid.insertAdjacentHTML('beforeend', productCard);
            });
            lucide.createIcons();
        }
        
        /**
         * Renders the Recently Viewed Products section.
         */
        function renderRecentlyViewed() {
            const section = document.getElementById('recently-viewed-section');
            const grid = document.getElementById('recently-viewed-grid');
            grid.innerHTML = ''; 

            const recentProducts = recentlyViewedIds
                .map(id => getProductById(id))
                .filter(p => p !== undefined);

            if (recentProducts.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');

            recentProducts.forEach(product => {
                const productCard = `
                    <div onclick="openQuickView(${product.id})" class="cursor-pointer bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-md hover:shadow-lg transition duration-200 transform hover:scale-[1.02] border border-gray-100 dark:border-gray-700">
                        <img src="${product.image}" alt="${product.name}" class="w-full h-32 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/400x400/E5E7EB/4B5563?text=N/A';">
                        <div class="p-3">
                            <h3 class="text-sm font-semibold text-gray-900 dark:text-white truncate">${product.name}</h3>
                            <p class="text-lg font-bold text-indigo-500">$${product.price.toFixed(2)}</p>
                        </div>
                    </div>
                `;
                grid.insertAdjacentHTML('beforeend', productCard);
            });
        }

        /**
         * Renders the Product Comparison Modal content.
         */
        function renderComparisonModal() {
            const container = document.getElementById('compare-items-container');
            const countEl = document.getElementById('compare-count-modal');
            container.innerHTML = '';
            
            countEl.textContent = productsToCompareIds.length;
            const productIds = productsToCompareIds;
            const placeholdersNeeded = MAX_COMPARE - productIds.length;

            // 1. Render actual products
            productIds.forEach(id => {
                const product = getProductById(id);
                if (!product) return;
                
                const ratingStars = generateRatingStars(product.rating);

                const productHtml = `
                    <div class="p-4 border rounded-lg dark:border-gray-700 flex flex-col items-center text-center bg-gray-50 dark:bg-gray-700">
                        <img src="${product.image}" alt="${product.name}" class="w-24 h-24 object-cover rounded-lg mb-3" onerror="this.onerror=null; this.src='https://placehold.co/200x200/E5E7EB/4B5563?text=N/A';">
                        <h4 class="text-xl font-bold mb-2 text-gray-900 dark:text-white">${product.name}</h4>
                        <button onclick="toggleComparison(${product.id}); renderComparisonModal();" class="text-red-500 hover:text-red-700 mb-3 text-sm">
                            <i data-lucide="x-circle" class="w-4 h-4 inline mr-1"></i> Remove
                        </button>
                        
                        <div class="w-full space-y-2 text-left text-gray-600 dark:text-gray-300">
                            <p class="font-bold text-indigo-600 dark:text-indigo-400 text-2xl border-t pt-2">$${product.price.toFixed(2)}</p>
                            <div class="flex items-center">
                                <span class="font-medium mr-2">Rating:</span>
                                <div class="flex">${ratingStars}</div>
                            </div>
                            <p><span class="font-medium">Reviews:</span> ${product.reviewsCount}</p>
                            <p><span class="font-medium">Category:</span> ${product.category}</p>
                            <p><span class="font-medium">Sizes:</span> ${product.sizes ? product.sizes.join(', ') : 'N/A'}</p>
                            <p><span class="font-medium">Colors:</span> ${product.colors ? product.colors.join(', ') : 'Default'}</p>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', productHtml);
            });

            // 2. Render placeholders
            for (let i = 0; i < placeholdersNeeded; i++) {
                const placeholderHtml = `
                    <div class="p-4 border border-dashed rounded-lg border-gray-300 dark:border-gray-600 flex flex-col items-center justify-center min-h-[300px]">
                        <i data-lucide="plus-circle" class="w-8 h-8 text-gray-400 mb-2"></i>
                        <p class="text-gray-500 font-medium">Add a product to compare</p>
                        <p class="text-sm text-gray-400">Use the scale icon on the product grid.</p>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', placeholderHtml);
            }
            lucide.createIcons();
        }

        /**
         * Toggles the visibility of the cart modal.
         */
        function toggleCart() {
            const modalBackdrop = document.getElementById('cart-modal-backdrop');
            const body = document.getElementById('body-container');
            
            if (body.classList.contains('show-wishlist')) toggleWishlistModal();
            if (body.classList.contains('show-quickview')) closeQuickView();
            if (body.classList.contains('show-compare')) closeComparisonModal();

            if (modalBackdrop.classList.contains('hidden')) {
                modalBackdrop.classList.remove('hidden');
                setTimeout(() => {
                    body.classList.add('show-cart');
                    body.classList.add('overflow-hidden'); 
                }, 10);
            } else {
                body.classList.remove('show-cart');
                body.classList.remove('overflow-hidden');
                setTimeout(() => {
                    modalBackdrop.classList.add('hidden');
                }, 500);
            }
        }
        
        /**
         * Renders the current state of the shopping cart in the modal.
         */
        function renderCart() {
            const itemsContainer = document.getElementById('cart-items-container');
            const emptyMessage = document.getElementById('empty-cart-message');
            const totalSummary = document.getElementById('cart-summary-totals');
            const couponInput = document.getElementById('coupon-code');
            const applyBtn = document.getElementById('apply-coupon-btn');
            const couponMsg = document.getElementById('coupon-message');

            let subtotalPrice = 0;

            itemsContainer.innerHTML = ''; // Clear items

            if (cart.length === 0) {
                emptyMessage.style.display = 'block';
            } else {
                emptyMessage.style.display = 'none';
                
                cart.forEach(item => {
                    const product = getProductById(item.id);
                    if (product) {
                        const itemTotal = product.price * item.quantity;
                        subtotalPrice += itemTotal;
                        
                        // Display size and color options
                        const optionsText = item.size !== 'N/A' ? `${item.size} / ${item.color}` : '';

                        const cartItemHtml = `
                            <div class="flex items-center space-x-4 border-b pb-4 dark:border-gray-700">
                                <img src="${product.image}" alt="${product.name}" class="w-16 h-16 rounded-lg object-cover border border-gray-100 dark:border-gray-700" onerror="this.onerror=null; this.src='https://placehold.co/100x100/E5E7EB/4B5563?text=No+Img';">
                                <div class="flex-grow">
                                    <p class="text-base font-semibold text-gray-900 dark:text-white">${product.name}</p>
                                    <p class="text-xs text-indigo-500">${optionsText}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">$${product.price.toFixed(2)} x ${item.quantity}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button onclick="changeQuantity('${item.cartItemId}', -1)" class="p-1 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                                        <i data-lucide="minus" class="w-4 h-4 text-gray-700 dark:text-gray-200"></i>
                                    </button>
                                    <span class="font-medium">${item.quantity}</span>
                                    <button onclick="changeQuantity('${item.cartItemId}', 1)" class="p-1 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                                        <i data-lucide="plus" class="w-4 h-4 text-gray-700 dark:text-gray-200"></i>
                                    </button>
                                </div>
                                <button onclick="removeFromCart('${item.cartItemId}')" class="p-1 text-red-500 hover:text-red-700 transition">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        `;
                        itemsContainer.insertAdjacentHTML('beforeend', cartItemHtml);
                    }
                });
            }
            
            // --- Coupon & Total Calculations ---
            const discountAmount = subtotalPrice * appliedCoupon.discountPercentage;
            const totalPrice = subtotalPrice - discountAmount;

            let totalsHtml = `
                <div class="flex justify-between items-center text-lg text-gray-700 dark:text-gray-300 mb-2">
                    <span>Subtotal:</span>
                    <span class="font-medium">$${subtotalPrice.toFixed(2)}</span>
                </div>
            `;
            
            if (appliedCoupon.code && appliedCoupon.discountPercentage > 0) {
                totalsHtml += `
                    <div class="flex justify-between items-center text-lg text-green-600 font-semibold mb-2">
                        <span class="flex items-center">
                            Discount (${appliedCoupon.code})
                            <button onclick="removeCoupon()" class="ml-2 text-red-500 hover:text-red-700">
                                <i data-lucide="x-circle" class="w-4 h-4"></i>
                            </button>
                        </span>
                        <span>-$${discountAmount.toFixed(2)}</span>
                    </div>
                `;
            }

            totalsHtml += `
                <div class="flex justify-between items-center font-bold text-2xl pt-2 border-t border-gray-200 dark:border-gray-700">
                    <span>Order Total:</span>
                    <span class="text-indigo-600">$${totalPrice.toFixed(2)}</span>
                </div>
            `;
            
            totalSummary.innerHTML = totalsHtml;
            
            // Update Coupon UI State
            if (appliedCoupon.code && appliedCoupon.discountPercentage > 0) {
                couponInput.value = appliedCoupon.code;
                couponInput.disabled = true;
                applyBtn.disabled = true;
                applyBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                applyBtn.classList.add('bg-gray-300', 'cursor-not-allowed');
                couponMsg.textContent = appliedCoupon.message;
                couponMsg.className = 'text-sm mt-2 font-medium text-green-600';
            } else {
                couponInput.disabled = false;
                applyBtn.disabled = false;
                applyBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                applyBtn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                couponMsg.textContent = appliedCoupon.message;
                couponMsg.className = 'text-sm mt-2 font-medium ' + (appliedCoupon.message.includes('Success') ? 'text-green-600' : 'text-red-500');
            }

            lucide.createIcons(); // Re-initialize icons
        }

        /**
         * Renders the current state of the wishlist in its modal.
         */
        function renderWishlist() {
            const itemsContainer = document.getElementById('wishlist-items-container');
            const emptyMessage = document.getElementById('empty-wishlist-message');

            itemsContainer.innerHTML = ''; // Clear items

            if (wishlist.length === 0) {
                emptyMessage.style.display = 'block';
            } else {
                emptyMessage.style.display = 'none';
                
                wishlist.forEach(item => {
                    const product = getProductById(item.id);
                    if (product) {
                        const wishlistHtml = `
                            <div class="flex items-start space-x-4 p-3 rounded-lg border border-gray-100 dark:border-gray-700 dark:bg-gray-700/50">
                                <img src="${product.image}" alt="${product.name}" class="w-16 h-16 rounded-lg object-cover" onerror="this.onerror=null; this.src='https://placehold.co/100x100/E5E7EB/4B5563?text=No+Img';">
                                <div class="flex-grow">
                                    <p class="text-base font-semibold text-gray-900 dark:text-white">${product.name}</p>
                                    <p class="text-lg font-bold text-indigo-600">$${product.price.toFixed(2)}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${product.category}</p>
                                </div>
                                <div class="flex flex-col space-y-2 items-end">
                                    <button onclick="moveToCart(${product.id})" class="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm flex items-center shadow-sm">
                                        <i data-lucide="shopping-cart" class="w-4 h-4 mr-1"></i> Add
                                    </button>
                                    <button onclick="toggleWishlist(${product.id})" class="p-2 text-gray-500 dark:text-gray-400 hover:text-red-600 transition">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        itemsContainer.insertAdjacentHTML('beforeend', wishlistHtml);
                    }
                });
            }
            
            lucide.createIcons();
        }

        /**
         * Updates the cart badge count in the header.
         */
        function updateCartCount() {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            const badge = document.getElementById('cart-count');
            badge.textContent = count;
            badge.classList.toggle('opacity-0', count === 0);
        }

        /**
         * Updates the wishlist badge count in the header.
         */
        function updateWishlistCount() {
            const count = wishlist.length;
            const badge = document.getElementById('wishlist-count');
            badge.textContent = count;
            badge.classList.toggle('opacity-0', count === 0);
        }
        
        /**
         * Updates the comparison badge count in the header.
         */
        function updateCompareCount() {
            const count = productsToCompareIds.length;
            const badge = document.getElementById('compare-count');
            badge.textContent = count;
            badge.classList.toggle('opacity-0', count === 0);
        }


        /**
         * Toggles between light and dark mode and persists the preference.
         */
        function toggleDarkMode() {
            const body = document.getElementById('body-container');
            const icon = document.getElementById('dark-mode-icon');
            
            body.classList.toggle('dark');
            const isDark = body.classList.contains('dark');
            
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');

            if (isDark) {
                icon.setAttribute('data-lucide', 'sun');
            } else {
                icon.setAttribute('data-lucide', 'moon');
            }
            lucide.createIcons();
        }

        /**
         * Applies the stored dark mode preference on initialization.
         */
        function initializeDarkMode() {
            const storedMode = localStorage.getItem('darkMode');
            const body = document.getElementById('body-container');
            const icon = document.getElementById('dark-mode-icon');
            
            if (storedMode === 'enabled') {
                body.classList.add('dark');
                icon.setAttribute('data-lucide', 'sun');
            } else {
                body.classList.remove('dark');
                icon.setAttribute('data-lucide', 'moon');
            }
        }
        
        /**
         * Simulates a newsletter sign-up and provides client-side feedback.
         */
        function simulateNewsletterSignup() {
            const emailInput = document.getElementById('newsletter-email');
            const messageElement = document.getElementById('newsletter-message');
            const email = emailInput.value.trim();

            messageElement.textContent = ''; // Clear previous message
            messageElement.classList.remove('text-red-500', 'text-green-500');

            if (!email || !email.includes('@') || !email.includes('.')) {
                messageElement.textContent = 'Please enter a valid email address.';
                messageElement.classList.add('text-red-500');
                showToast('Invalid email format.', 'error');
                return;
            }

            // Simulate server response delay
            setTimeout(() => {
                messageElement.textContent = `Success! Thank you for subscribing. A 15% off coupon was sent to ${email}.`;
                messageElement.classList.add('text-green-500');
                emailInput.value = '';
                showToast('Newsletter subscribed!', 'success');
            }, 500);
        }


        // --- Quick View Modal & Review Functions ---

        /**
         * NEW: Handles the image magnifier effect in the Quick View modal.
         * @param {Event} event - The mouse event.
         * @param {boolean} isOver - True if mouse is over the image, false on mouse leave.
         * @param {string} largeImageUrl - The URL of the image to magnify.
         */
        function handleImageMagnify(event, isOver, largeImageUrl) {
            const lens = document.getElementById('magnifier-lens');
            const mainImageContainer = event.currentTarget;
            
            if (!lens || !mainImageContainer) return;

            if (!isOver) {
                lens.style.opacity = '0';
                return;
            }

            // Set the background image on the lens
            lens.style.backgroundImage = `url('${largeImageUrl}')`;
            lens.style.opacity = '1';

            // Get dimensions of the main image container
            const rect = mainImageContainer.getBoundingClientRect();
            
            // Calculate cursor position relative to the container
            const x = event.clientX - rect.left; 
            const y = event.clientY - rect.top;

            const zoomFactor = 2; 
            const lensSize = 150; 
            
            // 1. Position the lens container: center it around the cursor, but keep it within bounds
            const lensX = Math.max(0, Math.min(rect.width - lensSize, x - (lensSize / 2)));
            const lensY = Math.max(0, Math.min(rect.height - lensSize, y - (lensSize / 2)));
            
            lens.style.left = `${lensX}px`;
            lens.style.top = `${lensY}px`;
            
            // 2. Position the magnified background inside the lens:
            // Calculate position of the cursor relative to the image itself
            const cursorX = x;
            const cursorY = y;

            const backgroundX = -cursorX * (zoomFactor - 1);
            const backgroundY = -cursorY * (zoomFactor - 1);
            
            lens.style.backgroundPosition = `${backgroundX}px ${backgroundY}px`;
            lens.style.backgroundSize = `${rect.width * zoomFactor}px ${rect.height * zoomFactor}px`;
        }

        /**
         * Submits a simulated review for the product.
         * @param {number} productId - The ID of the product being reviewed.
         */
        function submitReview(productId) {
            const name = document.getElementById(`review-name-${productId}`).value.trim();
            const comment = document.getElementById(`review-comment-${productId}`).value.trim();
            const ratingInput = document.querySelector(`input[name="review-rating-${productId}"]:checked`);
            const rating = ratingInput ? parseInt(ratingInput.value, 10) : null;
            const messageEl = document.getElementById(`review-message-${productId}`);

            messageEl.textContent = '';
            messageEl.className = 'text-sm mt-2 font-medium';

            if (!name || !comment || !rating) {
                messageEl.textContent = 'Please fill out your name, comment, and select a star rating.';
                messageEl.classList.add('text-red-500');
                return;
            }

            const newReview = {
                id: crypto.randomUUID(), 
                name: name,
                comment: comment,
                rating: rating,
                date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
            };

            if (!sessionReviews[productId]) {
                sessionReviews[productId] = [];
            }
            sessionReviews[productId].unshift(newReview); 

            messageEl.textContent = 'Review submitted successfully! Thank you for your feedback.';
            messageEl.classList.add('text-green-600');
            showToast('Review Submitted!', 'success');

            openQuickView(productId, { skipHistory: true });
        }


        function switchQuickViewImage(newSrc, element) {
            document.getElementById('quickview-main-image').src = newSrc;
            const thumbnails = document.querySelectorAll('.quickview-thumbnail');
            thumbnails.forEach(thumb => {
                thumb.classList.remove('ring-4', 'ring-indigo-500', 'ring-offset-2');
            });
            element.classList.add('ring-4', 'ring-indigo-500', 'ring-offset-2');
        }

        /**
         * Handles adding the product from quick view with selected options.
         * @param {number} id - Product ID
         */
        function quickViewAddToCart(id) {
            const product = getProductById(id);
            
            // Check stock before adding to cart
            if (product.stock <= 0) {
                showToast(`Cannot add ${product.name}. Currently Out of Stock.`, 'error');
                return;
            }
            
            const sizeSelect = document.getElementById(`size-select-${id}`);
            const colorSelect = document.getElementById(`color-select-${id}`);
            
            const size = sizeSelect ? sizeSelect.value : 'N/A';
            const color = colorSelect ? colorSelect.value : 'Default';

            if (product.sizes && size === '') {
                 showToast('Please select a Size.', 'error');
                 return;
            }
            if (product.colors && color === '') {
                 showToast('Please select a Color.', 'error');
                 return;
            }

            // Quantity is always 1 from quick view
            addToCart(id, 1, size, color);
            closeQuickView();
        }
        
        /**
         * Simulates tracking a price for a product.
         * @param {number} id - Product ID
         */
        function trackPrice(id) {
            const isTracked = priceTrackedIds.includes(id);
            const product = getProductById(id);
            
            if (isTracked) {
                priceTrackedIds = priceTrackedIds.filter(itemId => itemId !== id);
                showToast(`Price tracking stopped for ${product.name}.`, 'info');
            } else {
                priceTrackedIds.push(id);
                showToast(`We'll notify you if the price of ${product.name} drops!`, 'success');
            }
            updatePriceTrackedState();
            openQuickView(id, { skipHistory: true }); // Re-render to update button state
        }


        function openQuickView(id, options = {}) {
            const product = getProductById(id);
            if (!product) return;

            if (!options.skipHistory) {
                addRecentlyViewed(id);
            }

            const body = document.getElementById('body-container');
            if (body.classList.contains('show-cart')) toggleCart();
            if (body.classList.contains('show-wishlist')) toggleWishlistModal();
            if (body.classList.contains('show-compare')) closeComparisonModal();

            const modalContainer = document.getElementById('quickview-modal');
            const images = product.gallery || [product.image];
            const firstImage = images[0] || product.image;

            const thumbnailsHtml = images.map((imgSrc, index) => `
                <img src="${imgSrc}" 
                    alt="${product.name} View ${index + 1}" 
                    class="quickview-thumbnail w-16 h-16 object-cover rounded-lg cursor-pointer transition duration-150 border border-gray-200 dark:border-gray-600 ${index === 0 ? 'ring-4 ring-indigo-500 ring-offset-2' : ''}" 
                    onclick="switchQuickViewImage('${imgSrc}', this)"
                    onerror="this.onerror=null; this.src='https://placehold.co/60x60/E5E7EB/4B5563?text=N/A';"
                >
            `).join('');

            const staticReviews = [
                { id: 101, name: "Gemini", comment: "The comfort level is truly cosmic! Highly recommend this fabric.", rating: 5, date: "Sept 1, 2025" },
                { id: 102, name: "Orion", comment: "Fits perfectly and looks great. Wish it came in more colors.", rating: 4, date: "Aug 28, 2025" }
            ];
            
            const combinedReviews = [...(sessionReviews[id] || []), ...staticReviews];
            
            const reviewsHtml = combinedReviews.map(review => `
                <div class="border-t pt-4 dark:border-gray-700">
                    <div class="flex items-center space-x-2 mb-1">
                        <div class="flex">${generateRatingStars(review.rating)}</div>
                        <span class="text-sm font-semibold text-gray-900 dark:text-white">${review.name}</span>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">${review.date}</p>
                    <p class="text-gray-700 dark:text-gray-300">${review.comment}</p>
                </div>
            `).join('');

            const ratingStars = generateRatingStars(product.rating);
            
            // Options Selectors
            const sizesHtml = (product.sizes || []).map(size => `<option value="${size}">${size}</option>`).join('');
            const colorsHtml = (product.colors || []).map(color => `<option value="${color}">${color}</option>`).join('');
            
            const optionsSection = `
                <div class="flex space-x-4 mb-6">
                    <!-- Size Select -->
                    <div class="w-1/2">
                        <label for="size-select-${id}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Size</label>
                        <select id="size-select-${id}" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Select Size</option>
                            ${sizesHtml}
                        </select>
                    </div>
                    <!-- Color Select -->
                    <div class="w-1/2">
                        <label for="color-select-${id}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Color</label>
                        <select id="color-select-${id}" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Select Color</option>
                            ${colorsHtml}
                        </select>
                    </div>
                </div>
            `;
            
            // NEW: Stock Status Logic
            let stockStatus = '';
            let stockClass = '';
            let isOutOfStock = false;
            if (product.stock > 10) {
                stockStatus = 'In Stock';
                stockClass = 'text-green-600 bg-green-100 dark:bg-green-900/50';
            } else if (product.stock > 0) {
                stockStatus = `Low Stock (${product.stock} left)`;
                stockClass = 'text-yellow-600 bg-yellow-100 dark:bg-yellow-900/50';
            } else {
                stockStatus = 'Out of Stock';
                stockClass = 'text-red-600 bg-red-100 dark:bg-red-900/50';
                isOutOfStock = true;
            }

            const stockHtml = `
                <span class="text-sm font-semibold px-3 py-1 rounded-full ${stockClass} mt-3 inline-block">
                    <i data-lucide="${!isOutOfStock ? 'check-circle' : 'alert-circle'}" class="w-4 h-4 inline mr-1"></i>
                    ${stockStatus}
                </span>
            `;
            
            // Price Tracking Button State
            const isPriceTracked = priceTrackedIds.includes(id);
            const trackBtnClass = isPriceTracked ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600';
            const trackBtnText = isPriceTracked ? 'Price Tracking Active' : 'Track Price Drop';
            const trackBtnIcon = isPriceTracked ? 'bell-off' : 'bell';
            const trackBtnTextColor = isPriceTracked ? 'text-white' : 'text-gray-800 dark:text-gray-200';
            
            // Image Gallery with Magnifier
            const imageGalleryHtml = `
                <div class="order-1">
                    <!-- Main Image Container with Magnifier -->
                    <div class="image-magnifier-container relative w-full aspect-square rounded-xl overflow-hidden shadow-lg mb-4">
                        <img id="quickview-main-image" 
                            src="${firstImage}" 
                            alt="${product.name}" 
                            class="w-full h-full object-cover transition duration-300"
                            onerror="this.onerror=null; this.src='https://placehold.co/600x600/E5E7EB/4B5563?text=Image+Missing';">

                        <!-- Magnifier Lens -->
                        <div id="magnifier-lens"></div>

                        <!-- Mouse Trap for Magnifier -->
                        <div class="absolute inset-0 cursor-crosshair"
                            onmousemove="handleImageMagnify(event, true, '${firstImage}')" 
                            onmouseleave="handleImageMagnify(event, false)">
                        </div>
                    </div>
                    
                    <!-- Thumbnails/Gallery Controls -->
                    <div class="flex space-x-3 overflow-x-auto pb-2">
                        ${thumbnailsHtml}
                    </div>
                </div>
            `;
            
            const modalContent = `
                <div class="p-6">
                    <div class="flex justify-end mb-4">
                        <button onclick="closeQuickView()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                            <i data-lucide="x" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
                        </button>
                    </div>
                    
                    <!-- Breadcrumbs (Simulated) -->
                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                        <a href="#" class="hover:text-indigo-600">Home</a> > 
                        <span class="hover:text-indigo-600 cursor-pointer" onclick="document.getElementById('category-filter').value='${product.category}'; applyFilters(); closeQuickView();">${product.category}</span> > 
                        <span class="font-medium text-gray-700 dark:text-gray-200">${product.name}</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Left Column: Image Gallery (with Magnifier) -->
                        ${imageGalleryHtml}
                        
                        <!-- Right Column: Details & Actions -->
                        <div class="order-2 flex flex-col justify-between">
                            <div>
                                <h3 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">${product.name}</h3>
                                <span class="text-sm font-medium bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 px-3 py-1 rounded-full">${product.category}</span>
                                
                                <!-- Rating Display -->
                                <div class="flex items-center space-x-2 my-4">
                                    <div class="flex">${ratingStars}</div>
                                    <span class="text-sm font-medium text-gray-600 dark:text-gray-300">${product.rating} / 5</span>
                                    <span class="text-sm text-gray-500 dark:text-gray-400">(${product.reviewsCount + (sessionReviews[id]?.length || 0)} Reviews)</span>
                                </div>

                                <p class="text-4xl font-extrabold text-indigo-600 mb-0">$${product.price.toFixed(2)}</p>
                                ${stockHtml}
                                
                                <p class="text-gray-600 dark:text-gray-300 my-6">Ultra-soft, sustainable fabric designed for maximum comfort and style. Perfect for everyday wear or your next adventure. Limited stock available in this run.</p>
                                
                                <!-- Options Section -->
                                ${product.sizes ? optionsSection : ''}
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="mt-auto space-y-3">
                                <button onclick="quickViewAddToCart(${product.id});" 
                                    class="w-full bg-indigo-600 text-white p-4 rounded-xl text-lg font-semibold hover:bg-indigo-700 transition duration-200 flex items-center justify-center space-x-2 shadow-xl transform hover:scale-[1.01] ${isOutOfStock ? 'opacity-50 cursor-not-allowed' : ''}" ${isOutOfStock ? 'disabled' : ''}>
                                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                                    <span>${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}</span>
                                </button>
                                
                                <!-- Track Price Button -->
                                <button onclick="trackPrice(${product.id})" 
                                    class="w-full ${trackBtnClass} ${trackBtnTextColor} p-3 rounded-xl text-sm font-semibold transition duration-200 flex items-center justify-center space-x-2 shadow-md">
                                    <i data-lucide="${trackBtnIcon}" class="w-4 h-4"></i>
                                    <span>${trackBtnText}</span>
                                </button>
                            </div>
                        </div>

                        <!-- Full Width Section for Reviews (Order 3) -->
                        <div class="col-span-full order-3 mt-6">
                            <h4 class="text-2xl font-bold text-gray-900 dark:text-white mb-4 border-t pt-4">Customer Reviews</h4>
                            
                            <!-- Submit Review Form -->
                            <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg mb-6 border border-gray-100 dark:border-gray-700">
                                <h5 class="text-xl font-semibold mb-3">Write a Review</h5>
                                <div class="space-y-3">
                                    <input type="text" id="review-name-${id}" placeholder="Your Name" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" value="Anonymous">
                                    <div class="flex items-center space-x-3">
                                        <label class="font-medium text-sm">Your Rating:</label>
                                        
                                        <div id="review-star-selector" class="rating-container">
                                            ${[5, 4, 3, 2, 1].map(r => `
                                                <input type="radio" id="rating-${id}-${r}" name="review-rating-${id}" value="${r}" ${r === 5 ? 'checked' : ''}>
                                                <label for="rating-${id}-${r}">★</label>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <textarea id="review-comment-${id}" rows="3" placeholder="Tell us about your experience..." class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600"></textarea>
                                    <button onclick="submitReview(${id})" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700 transition shadow-md">Submit Review</button>
                                    <p id="review-message-${id}"></p>
                                </div>
                            </div>

                            <!-- Review List -->
                            <div id="review-list" class="space-y-4">
                                ${reviewsHtml.length > 0 ? reviewsHtml : '<p class="text-gray-500">Be the first to leave a review!</p>'}
                            </div>
                        </div>

                    </div>
                </div>
            `;
            
            modalContainer.innerHTML = modalContent;

            document.getElementById('quickview-modal-backdrop').classList.remove('hidden');
            body.classList.add('show-quickview');
            body.classList.add('overflow-hidden');
            lucide.createIcons();
            
            // Set initial options for quick buy selectors
            const initialSize = product.sizes?.[0];
            const initialColor = product.colors?.[0];
            if (initialSize && document.getElementById(`size-select-${id}`)) document.getElementById(`size-select-${id}`).value = initialSize;
            if (initialColor && document.getElementById(`color-select-${id}`)) document.getElementById(`color-select-${id}`).value = initialColor;
        }

        function closeQuickView() {
            const body = document.getElementById('body-container');
            
            body.classList.remove('show-quickview');
            body.classList.remove('overflow-hidden');

            setTimeout(() => {
                document.getElementById('quickview-modal-backdrop').classList.add('hidden');
            }, 300); 
        }

        // --- Initialization ---

        /**
         * Initializes the store application.
         */
        function initStore() {
            initializeDarkMode();
            applyFilters(); 
            updateCartCount();
            updateWishlistCount();
            updateCompareCount(); 
            renderCart(); 
            renderWishlist(); 
            renderRecentlyViewed(); 

            // Sticky Header Shadow Listener
            window.addEventListener('scroll', () => {
                const header = document.getElementById('main-header');
                if (window.scrollY > 50) {
                    header.classList.add('header-scrolled');
                } else {
                    header.classList.remove('header-scrolled');
                }
            });
        }

        window.onload = initStore;
    </script>
</body>
</html>
