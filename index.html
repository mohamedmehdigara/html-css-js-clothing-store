<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Threads - Modern Apparel</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom font import and application */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            font-family: 'Inter', sans-serif;
        }

        /* Utility class for the sticky header shadow */
        .header-scrolled {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* Cart Modal backdrop styling */
        #cart-modal-backdrop, #wishlist-modal-backdrop {
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            z-index: 50; /* Ensure modals are on top */
        }
        
        /* Cart Modal (Right side) */
        #cart-modal { transform: translateX(100%); }
        .show-cart #cart-modal-backdrop { opacity: 1; pointer-events: auto; }
        .show-cart #cart-modal { transform: translateX(0); }

        /* Wishlist Modal (Left side - NEW) */
        #wishlist-modal { transform: translateX(-100%); }
        .show-wishlist #wishlist-modal-backdrop { opacity: 1; pointer-events: auto; }
        .show-wishlist #wishlist-modal { transform: translateX(0); }

        /* Quick View Modal styling */
        .show-quickview #quickview-modal-backdrop { opacity: 1; pointer-events: auto; }
        .show-quickview #quickview-modal { transform: scale(1); opacity: 1; }

        /* Custom scrollbar styling for the product grid on smaller screens */
        @media (max-width: 768px) {
            #product-grid {
                overflow-x: auto;
                scroll-snap-type: x mandatory;
            }
            .product-card {
                scroll-snap-align: start;
                flex: 0 0 80%;
                margin-right: 1rem;
            }
        }
    </style>
</head>
<!-- Apply dark class dynamically to enable dark mode -->
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-500" id="body-container">

    <!-- Header & Navigation -->
    <header id="main-header" class="sticky top-0 z-40 bg-white dark:bg-gray-800 transition duration-300">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <a href="#" class="text-3xl font-extrabold text-indigo-700 tracking-tight">
                Stellar Threads
            </a>
            
            <!-- Action Buttons -->
            <div class="flex space-x-3 items-center">
                
                <!-- Dark Mode Toggle (NEW) -->
                <button id="dark-mode-toggle" onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150">
                    <i id="dark-mode-icon" data-lucide="moon" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
                </button>
                
                <!-- Wishlist Button (NEW) -->
                <button id="wishlist-button" onclick="toggleWishlistModal()" class="relative p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150">
                    <span id="wishlist-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full opacity-0 transition-opacity duration-300">0</span>
                    <i data-lucide="heart" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
                </button>

                <!-- Cart Button -->
                <button id="cart-button" onclick="toggleCart()" class="relative p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150">
                    <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full opacity-0 transition-opacity duration-300">0</span>
                    <i data-lucide="shopping-cart" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content: Hero Section -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 mt-12 mb-20">
        <section class="text-center mb-16 p-8 bg-indigo-50 dark:bg-indigo-900 rounded-2xl shadow-lg transition-colors duration-500">
            <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 dark:text-white mb-4 tracking-tight">
                New Arrivals: Cosmic Comfort
            </h1>
            <p class="text-xl text-gray-600 dark:text-gray-300 max-w-2xl mx-auto mb-6">
                Explore our latest collection of sustainable and ultra-soft essentials, designed for your journey.
            </p>
            <button class="bg-indigo-600 text-white px-8 py-3 rounded-xl text-lg font-semibold shadow-xl hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                Shop the Collection
            </button>
        </section>

        <!-- Product Listing Header and Controls -->
        <div class="flex flex-col gap-4 mb-8">
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Featured Products</h2>
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <!-- Search Bar -->
                <div class="relative w-full sm:w-1/3">
                    <input type="text" id="product-search" oninput="applyFilters()" placeholder="Search products..." class="w-full p-2 pl-10 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                </div>
                
                <div class="flex space-x-4 w-full sm:w-auto">
                    <!-- Category Filter -->
                    <select id="category-filter" onchange="applyFilters()" class="p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500 w-1/2 sm:w-auto">
                        <option value="all">All Categories</option>
                        <option value="T-Shirts">T-Shirts</option>
                        <option value="Hoodies">Hoodies</option>
                        <option value="Jeans">Jeans</option>
                        <option value="Shirts">Shirts</option>
                        <option value="Bottoms">Bottoms</option>
                        <option value="Sweaters">Sweaters</option>
                    </select>
                    
                    <!-- Sort By -->
                    <select id="sort-by" onchange="applyFilters()" class="p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500 w-1/2 sm:w-auto">
                        <option value="default">Sort: Default</option>
                        <option value="low-high">Price: Low to High</option>
                        <option value="high-low">Price: High to Low</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Product Grid -->
        <section id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 md:gap-8 pb-4">
            <!-- Product cards will be injected here by JavaScript -->
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-12">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                <!-- Column 1: Brand Info -->
                <div>
                    <h4 class="text-xl font-bold mb-4 text-indigo-400">Stellar Threads</h4>
                    <p class="text-sm text-gray-400">Sustainable style for the modern explorer.</p>
                </div>
                <!-- Column 4: Contact -->
                <div>
                    <h4 class="font-semibold mb-4 border-b border-indigo-700 pb-1">Connect</h4>
                    <p class="text-sm text-gray-300">Email: info@stellarthreads.com</p>
                    <div class="flex space-x-3 mt-3">
                        <i data-lucide="instagram" class="w-5 h-5 cursor-pointer hover:text-indigo-400 transition"></i>
                        <i data-lucide="facebook" class="w-5 h-5 cursor-pointer hover:text-indigo-400 transition"></i>
                        <i data-lucide="twitter" class="w-5 h-5 cursor-pointer hover:text-indigo-400 transition"></i>
                    </div>
                </div>
            </div>
            <div class="mt-8 pt-6 border-t border-gray-800 text-center text-sm text-gray-500">
                &copy; 2025 Stellar Threads. All rights reserved.
            </div>
        </div>
    </footer>
    
    <!-- Wishlist Modal (NEW - Left Side) -->
    <div id="wishlist-modal-backdrop" onclick="toggleWishlistModal()" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm opacity-0 hidden transition duration-300">
        <div id="wishlist-modal" onclick="event.stopPropagation()" class="fixed top-0 left-0 w-full md:w-96 h-full bg-white dark:bg-gray-800 shadow-2xl transform transition duration-500 ease-in-out">
            
            <!-- Wishlist Header -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Your Wishlist</h3>
                <button onclick="toggleWishlistModal()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <i data-lucide="x" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
                </button>
            </div>

            <!-- Wishlist Items Container -->
            <div id="wishlist-items-container" class="h-full overflow-y-auto max-h-[calc(100vh-80px)] p-6 space-y-4">
                <!-- Wishlist items will be injected here -->
                <p id="empty-wishlist-message" class="text-gray-500 text-center py-10">Your wishlist is empty. Save items you love!</p>
            </div>
        </div>
    </div>


    <!-- Shopping Cart Modal (Right Side) -->
    <div id="cart-modal-backdrop" onclick="toggleCart()" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm opacity-0 hidden transition duration-300">
        <div id="cart-modal" onclick="event.stopPropagation()" class="fixed top-0 right-0 w-full md:w-96 h-full bg-white dark:bg-gray-800 shadow-2xl transform transition duration-500 ease-in-out">
            
            <!-- Cart Header -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Your Cart</h3>
                <button onclick="toggleCart()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <i data-lucide="x" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
                </button>
            </div>

            <!-- Cart Items Container -->
            <div id="cart-items-container" class="h-auto overflow-y-auto max-h-[calc(100vh-350px)] p-6 space-y-4">
                <!-- Cart items will be injected here -->
                <p id="empty-cart-message" class="text-gray-500 text-center py-10">Your cart is empty. Start shopping!</p>
            </div>

            <!-- Coupon Input -->
            <div class="p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700">
                <label for="coupon-code" class="text-sm font-semibold text-gray-700 dark:text-gray-200 block mb-2">Have a Coupon Code?</label>
                <div class="flex space-x-2">
                    <input type="text" id="coupon-code" placeholder="e.g. GEMINI20" class="flex-grow p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="apply-coupon-btn" onclick="applyCoupon()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition shadow-md">Apply</button>
                </div>
                <p id="coupon-message" class="text-sm mt-2 font-medium"></p>
            </div>


            <!-- Cart Summary & Checkout -->
            <div class="absolute bottom-0 w-full p-6 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                <div id="cart-summary-totals">
                    <!-- Totals (Subtotal, Discount, Total) will be injected here by JS -->
                </div>
                <button onclick="checkout()" class="w-full bg-green-600 text-white px-6 py-3 rounded-xl text-lg font-semibold hover:bg-green-700 transition duration-300 shadow-lg mt-4">
                    Proceed to Checkout
                </button>
            </div>

        </div>
    </div>

    <!-- Quick View Modal -->
    <div id="quickview-modal-backdrop" onclick="closeQuickView()" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm opacity-0 hidden transition duration-300 flex items-center justify-center p-4">
        <div id="quickview-modal" onclick="event.stopPropagation()" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-90 opacity-0 transition duration-300 ease-in-out">
            <!-- Modal content will be injected here by openQuickView() -->
        </div>
    </div>

    <!-- JavaScript for Store Logic -->
    <script>
        // Store Product Data - Added 'gallery' array for multiple product views
        const PRODUCTS = [
            { id: 1, name: "The Classic Tee (Navy)", price: 29.99, image: "https://placehold.co/600x600/3B82F6/FFFFFF?text=Navy+Tee+FRONT", category: "T-Shirts", 
              gallery: ["https://placehold.co/600x600/3B82F6/FFFFFF?text=Navy+Tee+FRONT", "https://placehold.co/600x600/2563EB/FFFFFF?text=Navy+Tee+BACK", "https://placehold.co/600x600/1D4ED8/FFFFFF?text=Navy+Tee+DETAIL"] },
            { id: 2, name: "Urban Explorer Hoodie", price: 59.99, image: "https://placehold.co/600x600/4B5563/FFFFFF?text=Grey+Hoodie+FRONT", category: "Hoodies", 
              gallery: ["https://placehold.co/600x600/4B5563/FFFFFF?text=Grey+Hoodie+FRONT", "https://placehold.co/600x600/374151/FFFFFF?text=Grey+Hoodie+HOOD", "https://placehold.co/600x600/1F2937/FFFFFF?text=Grey+Hoodie+POCKET"] },
            { id: 3, name: "Essential Denim (Slim Fit)", price: 79.99, image: "https://placehold.co/600x600/10B981/FFFFFF?text=Denim+Jeans", category: "Jeans" },
            { id: 4, name: "Plaid Overshirt (Autumn)", price: 49.99, image: "https://placehold.co/600x600/F59E0B/FFFFFF?text=Plaid+Shirt", category: "Shirts" },
            { id: 5, name: "Aero Joggers", price: 64.99, image: "https://placehold.co/600x600/8B5CF6/FFFFFF?text=Purple+Joggers", category: "Bottoms" },
            { id: 6, name: "Minimalist Sweater", price: 54.99, image: "https://placehold.co/600x600/EF4444/FFFFFF?text=Red+Sweater", category: "Sweaters" },
        ];
        
        // Available Coupon Codes
        const VALID_COUPONS = {
            'GEMINI20': 0.20, // 20% off
            'SAVE10': 0.10,   // 10% off
            'NEWUSER': 0.15,  // 15% off
        };

        // Global State
        let cart = JSON.parse(localStorage.getItem('stellarThreadsCart')) || [];
        let wishlist = JSON.parse(localStorage.getItem('stellarThreadsWishlist')) || []; // NEW: Wishlist State
        let appliedCoupon = { code: null, discountPercentage: 0, message: '' }; 

        const initialProducts = [...PRODUCTS].sort((a, b) => a.id - b.id);
        let displayedProducts = [...initialProducts]; 

        // --- Core Utility Functions ---

        /**
         * Finds a product by its ID.
         * @param {number} id - The product ID.
         * @returns {object | undefined} The product object.
         */
        function getProductById(id) {
            return PRODUCTS.find(p => p.id === id);
        }
        
        /**
         * Checks if a product is in the wishlist.
         * @param {number} id - The product ID.
         * @returns {boolean} True if in wishlist.
         */
        function checkIfInWishlist(id) {
            return wishlist.some(item => item.id === id);
        }

        /**
         * Updates the localStorage and re-renders UI elements related to the cart.
         */
        function updateCartState() {
            localStorage.setItem('stellarThreadsCart', JSON.stringify(cart));
            renderCart();
            updateCartCount();
        }

        /**
         * Updates the localStorage and re-renders UI elements related to the wishlist.
         */
        function updateWishlistState() { // NEW
            localStorage.setItem('stellarThreadsWishlist', JSON.stringify(wishlist));
            renderWishlist();
            updateWishlistCount();
            renderProducts(); // Re-render product cards to update heart icons
        }

        // --- UI Rendering Functions ---

        /**
         * Renders the product cards onto the main page.
         */
        function renderProducts() {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = ''; 

            if (displayedProducts.length === 0) {
                 grid.innerHTML = '<p class="col-span-full text-center py-10 text-xl text-gray-500 dark:text-gray-400">No products match your current search and filter criteria.</p>';
                 return;
            }

            displayedProducts.forEach(product => {
                const isWished = checkIfInWishlist(product.id);
                const heartColor = isWished ? 'fill-red-500 text-red-500' : 'text-gray-500';

                const productCard = `
                    <div class="product-card bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition duration-300 transform hover:-translate-y-1 flex flex-col justify-between border border-gray-100 dark:border-gray-700">
                        <div class="relative overflow-hidden">
                            <img src="${product.image}" alt="${product.name}" class="w-full h-auto object-cover transition duration-500 hover:scale-105" onerror="this.onerror=null; this.src='https://placehold.co/600x600/E5E7EB/4B5563?text=Image+Missing';">
                            <span class="absolute top-2 left-2 text-xs font-medium bg-indigo-600 text-white px-2 py-1 rounded-full">${product.category}</span>
                            
                            <!-- Wishlist Toggle Button (NEW) -->
                            <button onclick="toggleWishlist(${product.id})" class="absolute top-2 right-2 p-2 rounded-full bg-white dark:bg-gray-900/80 backdrop-blur-sm hover:bg-red-100 dark:hover:bg-red-900/50 transition shadow-md">
                                <i data-lucide="heart" class="w-5 h-5 ${heartColor}"></i>
                            </button>

                        </div>
                        <div class="p-4 flex flex-col flex-grow">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-1">${product.name}</h3>
                            <p class="text-2xl font-bold text-indigo-600 mb-3">$${product.price.toFixed(2)}</p>
                            
                            <!-- Updated buttons for Quick View and Add to Cart -->
                            <div class="mt-auto flex space-x-2">
                                <button onclick="openQuickView(${product.id})" 
                                    class="w-1/2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 p-3 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-200 flex items-center justify-center space-x-1 shadow-sm text-sm">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                    <span>Quick View</span>
                                </button>
                                <button onclick="addToCart(${product.id})" 
                                    class="w-1/2 bg-indigo-600 text-white p-3 rounded-lg font-medium hover:bg-indigo-700 transition duration-200 flex items-center justify-center space-x-1 shadow-md text-sm">
                                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                                    <span>Add</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                grid.insertAdjacentHTML('beforeend', productCard);
            });
            // Re-initialize Lucide icons for dynamically added elements
            lucide.createIcons();
        }

        /**
         * Renders the current state of the shopping cart in the modal.
         */
        function renderCart() {
            const itemsContainer = document.getElementById('cart-items-container');
            const emptyMessage = document.getElementById('empty-cart-message');
            const totalSummary = document.getElementById('cart-summary-totals');
            const couponInput = document.getElementById('coupon-code');
            const applyBtn = document.getElementById('apply-coupon-btn');
            const couponMsg = document.getElementById('coupon-message');

            let subtotalPrice = 0;

            itemsContainer.innerHTML = ''; // Clear items

            if (cart.length === 0) {
                emptyMessage.style.display = 'block';
            } else {
                emptyMessage.style.display = 'none';
                
                cart.forEach(item => {
                    const product = getProductById(item.id);
                    if (product) {
                        const itemTotal = product.price * item.quantity;
                        subtotalPrice += itemTotal;
                        
                        const cartItemHtml = `
                            <div class="flex items-center space-x-4 border-b pb-4 dark:border-gray-700">
                                <img src="${product.image}" alt="${product.name}" class="w-16 h-16 rounded-lg object-cover border border-gray-100 dark:border-gray-700" onerror="this.onerror=null; this.src='https://placehold.co/100x100/E5E7EB/4B5563?text=No+Img';">
                                <div class="flex-grow">
                                    <p class="text-base font-semibold text-gray-900 dark:text-white">${product.name}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">$${product.price.toFixed(2)} x ${item.quantity}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button onclick="changeQuantity(${item.id}, -1)" class="p-1 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                                        <i data-lucide="minus" class="w-4 h-4 text-gray-700 dark:text-gray-200"></i>
                                    </button>
                                    <span class="font-medium">${item.quantity}</span>
                                    <button onclick="changeQuantity(${item.id}, 1)" class="p-1 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                                        <i data-lucide="plus" class="w-4 h-4 text-gray-700 dark:text-gray-200"></i>
                                    </button>
                                </div>
                                <button onclick="removeFromCart(${item.id})" class="p-1 text-red-500 hover:text-red-700 transition">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        `;
                        itemsContainer.insertAdjacentHTML('beforeend', cartItemHtml);
                    }
                });
            }
            
            // --- Coupon & Total Calculations ---
            const discountAmount = subtotalPrice * appliedCoupon.discountPercentage;
            const totalPrice = subtotalPrice - discountAmount;

            let totalsHtml = `
                <div class="flex justify-between items-center text-lg text-gray-700 dark:text-gray-300 mb-2">
                    <span>Subtotal:</span>
                    <span class="font-medium">$${subtotalPrice.toFixed(2)}</span>
                </div>
            `;
            
            // Display discount line if applied
            if (appliedCoupon.code && appliedCoupon.discountPercentage > 0) {
                totalsHtml += `
                    <div class="flex justify-between items-center text-lg text-green-600 font-semibold mb-2">
                        <span class="flex items-center">
                            Discount (${appliedCoupon.code})
                            <button onclick="removeCoupon()" class="ml-2 text-red-500 hover:text-red-700">
                                <i data-lucide="x-circle" class="w-4 h-4"></i>
                            </button>
                        </span>
                        <span>-$${discountAmount.toFixed(2)}</span>
                    </div>
                `;
            }

            // Final Total
            totalsHtml += `
                <div class="flex justify-between items-center font-bold text-2xl pt-2 border-t border-gray-200 dark:border-gray-700">
                    <span>Order Total:</span>
                    <span class="text-indigo-600">$${totalPrice.toFixed(2)}</span>
                </div>
            `;
            
            totalSummary.innerHTML = totalsHtml;
            
            // Update Coupon UI State
            if (appliedCoupon.code) {
                couponInput.value = appliedCoupon.code;
                couponInput.disabled = true;
                applyBtn.disabled = true;
                applyBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                applyBtn.classList.add('bg-gray-300', 'cursor-not-allowed');
                couponMsg.textContent = appliedCoupon.message;
                couponMsg.className = 'text-sm mt-2 font-medium text-green-600';
            } else {
                couponInput.disabled = false;
                applyBtn.disabled = false;
                applyBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                applyBtn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                couponMsg.textContent = appliedCoupon.message;
                couponMsg.className = 'text-sm mt-2 font-medium text-red-500';
            }

            lucide.createIcons(); // Re-initialize icons
        }

        /**
         * Renders the current state of the wishlist in its modal. (NEW)
         */
        function renderWishlist() {
            const itemsContainer = document.getElementById('wishlist-items-container');
            const emptyMessage = document.getElementById('empty-wishlist-message');

            itemsContainer.innerHTML = ''; // Clear items

            if (wishlist.length === 0) {
                emptyMessage.style.display = 'block';
            } else {
                emptyMessage.style.display = 'none';
                
                wishlist.forEach(item => {
                    const product = getProductById(item.id);
                    if (product) {
                        const wishlistHtml = `
                            <div class="flex items-start space-x-4 p-3 rounded-lg border border-gray-100 dark:border-gray-700 dark:bg-gray-700/50">
                                <img src="${product.image}" alt="${product.name}" class="w-16 h-16 rounded-lg object-cover" onerror="this.onerror=null; this.src='https://placehold.co/100x100/E5E7EB/4B5563?text=No+Img';">
                                <div class="flex-grow">
                                    <p class="text-base font-semibold text-gray-900 dark:text-white">${product.name}</p>
                                    <p class="text-lg font-bold text-indigo-600">$${product.price.toFixed(2)}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${product.category}</p>
                                </div>
                                <div class="flex flex-col space-y-2 items-end">
                                    <button onclick="moveToCart(${product.id})" class="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm flex items-center shadow-sm">
                                        <i data-lucide="shopping-cart" class="w-4 h-4 mr-1"></i> Add
                                    </button>
                                    <button onclick="toggleWishlist(${product.id})" class="p-2 text-gray-500 dark:text-gray-400 hover:text-red-600 transition">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        itemsContainer.insertAdjacentHTML('beforeend', wishlistHtml);
                    }
                });
            }
            
            lucide.createIcons();
        }

        /**
         * Updates the cart badge count in the header.
         */
        function updateCartCount() {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            const badge = document.getElementById('cart-count');
            badge.textContent = count;
            badge.classList.toggle('opacity-0', count === 0);
        }

        /**
         * Updates the wishlist badge count in the header. (NEW)
         */
        function updateWishlistCount() {
            const count = wishlist.length;
            const badge = document.getElementById('wishlist-count');
            badge.textContent = count;
            badge.classList.toggle('opacity-0', count === 0);
        }

        // --- Dark Mode Functions (NEW) ---

        /**
         * Toggles between light and dark mode and persists the preference.
         */
        function toggleDarkMode() {
            const body = document.getElementById('body-container');
            const icon = document.getElementById('dark-mode-icon');
            
            body.classList.toggle('dark');
            const isDark = body.classList.contains('dark');
            
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');

            // Update icon
            if (isDark) {
                icon.setAttribute('data-lucide', 'sun');
            } else {
                icon.setAttribute('data-lucide', 'moon');
            }
            lucide.createIcons();
        }

        /**
         * Applies the stored dark mode preference on initialization.
         */
        function initializeDarkMode() {
            const storedMode = localStorage.getItem('darkMode');
            const body = document.getElementById('body-container');
            const icon = document.getElementById('dark-mode-icon');
            
            if (storedMode === 'enabled') {
                body.classList.add('dark');
                icon.setAttribute('data-lucide', 'sun');
            } else {
                body.classList.remove('dark');
                icon.setAttribute('data-lucide', 'moon');
            }
        }

        // --- Wishlist Action Functions (NEW) ---

        /**
         * Adds or removes a product from the wishlist.
         * @param {number} id - The product ID.
         */
        function toggleWishlist(id) {
            const itemIndex = wishlist.findIndex(item => item.id === id);

            if (itemIndex !== -1) {
                // Remove from wishlist
                wishlist.splice(itemIndex, 1);
            } else {
                // Add to wishlist
                wishlist.push({ id: id });
            }

            updateWishlistState();
        }

        /**
         * Moves an item from the wishlist to the cart.
         * @param {number} id - The product ID.
         */
        function moveToCart(id) {
            // 1. Add to Cart
            addToCart(id); 
            // 2. Remove from Wishlist
            wishlist = wishlist.filter(item => item.id !== id);
            
            // 3. Update states
            updateWishlistState();
            // Since addToCart already calls updateCartState, we only need to update wishlist state.
        }

        /**
         * Toggles the visibility of the wishlist modal.
         */
        function toggleWishlistModal() {
            const modalBackdrop = document.getElementById('wishlist-modal-backdrop');
            const body = document.getElementById('body-container');

            // Close cart/quickview first if open
            if (body.classList.contains('show-cart')) toggleCart();
            if (body.classList.contains('show-quickview')) closeQuickView();
            
            if (modalBackdrop.classList.contains('hidden')) {
                modalBackdrop.classList.remove('hidden');
                setTimeout(() => {
                    body.classList.add('show-wishlist');
                    body.classList.add('overflow-hidden');
                }, 10);
            } else {
                body.classList.remove('show-wishlist');
                body.classList.remove('overflow-hidden');
                setTimeout(() => {
                    modalBackdrop.classList.add('hidden');
                }, 500);
            }
        }

        // --- Coupon Action Functions ---

        /**
         * Applies the coupon code entered by the user.
         */
        function applyCoupon() {
            const inputElement = document.getElementById('coupon-code');
            const code = inputElement.value.toUpperCase().trim();

            if (!code) {
                appliedCoupon = { code: null, discountPercentage: 0, message: 'Please enter a coupon code.' };
            } else if (VALID_COUPONS[code]) {
                const discount = VALID_COUPONS[code];
                appliedCoupon = { 
                    code: code, 
                    discountPercentage: discount, 
                    message: `Coupon '${code}' applied! You save ${(discount * 100)}% on your order.`
                };
            } else {
                appliedCoupon = { code: null, discountPercentage: 0, message: `Invalid coupon code: '${code}'.` };
            }

            renderCart(); 
        }

        /**
         * Removes the currently applied coupon.
         */
        function removeCoupon() {
            appliedCoupon = { code: null, discountPercentage: 0, message: '' };
            document.getElementById('coupon-code').value = '';
            renderCart();
        }

        // --- Cart Action Functions ---

        /**
         * Adds an item to the cart or increments its quantity.
         * @param {number} id - The ID of the product to add.
         */
        function addToCart(id) {
            const existingItem = cart.find(item => item.id === id);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ id: id, quantity: 1 });
            }

            updateCartState();
            // Show cart modal briefly on add
            const modalBackdrop = document.getElementById('cart-modal-backdrop');
            if (modalBackdrop.classList.contains('hidden')) {
                toggleCart();
                setTimeout(toggleCart, 3000); 
            }
        }

        /**
         * Changes the quantity of an item in the cart.
         */
        function changeQuantity(id, delta) {
            const itemIndex = cart.findIndex(item => item.id === id);

            if (itemIndex !== -1) {
                cart[itemIndex].quantity += delta;

                if (cart[itemIndex].quantity <= 0) {
                    cart.splice(itemIndex, 1);
                }
                
                updateCartState();
            }
        }

        /**
         * Removes an item entirely from the cart.
         */
        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            updateCartState();
        }

        /**
         * Toggles the visibility of the cart modal.
         */
        function toggleCart() {
            const modalBackdrop = document.getElementById('cart-modal-backdrop');
            const body = document.getElementById('body-container');
            const modal = document.getElementById('cart-modal');
            
            // Close wishlist/quickview first if open
            if (body.classList.contains('show-wishlist')) toggleWishlistModal();
            if (body.classList.contains('show-quickview')) closeQuickView();


            if (modalBackdrop.classList.contains('hidden')) {
                // Show modal
                modalBackdrop.classList.remove('hidden');
                setTimeout(() => {
                    body.classList.add('show-cart');
                    body.classList.add('overflow-hidden'); 
                }, 10);
            } else {
                // Hide modal
                body.classList.remove('show-cart');
                body.classList.remove('overflow-hidden');
                setTimeout(() => {
                    modalBackdrop.classList.add('hidden');
                }, 500);
            }
        }

        /**
         * Simulates the checkout process.
         */
        function checkout() {
            const subtotal = cart.reduce((sum, item) => sum + (getProductById(item.id)?.price || 0) * item.quantity, 0);
            const finalTotal = subtotal * (1 - appliedCoupon.discountPercentage);
            
            const message = cart.length === 0 
                ? 'Your cart is empty! Add some items before checking out.'
                : `Thank you for your order! Final Total: $${finalTotal.toFixed(2)}.\nThe cart has been cleared.`;

            window.alert(message); 
            
            if (cart.length > 0) {
                // Clear cart state
                cart = [];
                appliedCoupon = { code: null, discountPercentage: 0, message: '' };
                updateCartState();
                toggleCart();
            }
        }
        
        // --- Quick View Image Gallery Functions ---
        function switchQuickViewImage(newSrc, element) {
            document.getElementById('quickview-main-image').src = newSrc;
            const thumbnails = document.querySelectorAll('.quickview-thumbnail');
            thumbnails.forEach(thumb => {
                thumb.classList.remove('ring-4', 'ring-indigo-500', 'ring-offset-2');
            });
            element.classList.add('ring-4', 'ring-indigo-500', 'ring-offset-2');
        }

        function openQuickView(id) {
            const product = getProductById(id);
            if (!product) return;

            // Close other modals
            const body = document.getElementById('body-container');
            if (body.classList.contains('show-cart')) toggleCart();
            if (body.classList.contains('show-wishlist')) toggleWishlistModal();

            const modalContainer = document.getElementById('quickview-modal');
            const images = product.gallery || [product.image];
            const firstImage = images[0] || product.image;

            const thumbnailsHtml = images.map((imgSrc, index) => `
                <img src="${imgSrc}" 
                    alt="${product.name} View ${index + 1}" 
                    class="quickview-thumbnail w-16 h-16 object-cover rounded-lg cursor-pointer transition duration-150 border border-gray-200 dark:border-gray-600 ${index === 0 ? 'ring-4 ring-indigo-500 ring-offset-2' : ''}" 
                    onclick="switchQuickViewImage('${imgSrc}', this)"
                    onerror="this.onerror=null; this.src='https://placehold.co/60x60/E5E7EB/4B5563?text=N/A';"
                >
            `).join('');

            const modalContent = `
                <div class="p-6">
                    <div class="flex justify-end mb-4">
                        <button onclick="closeQuickView()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                            <i data-lucide="x" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
                        </button>
                    </div>
                    <div class="flex flex-col md:flex-row md:space-x-6">
                        <!-- Image Column (Gallery) -->
                        <div class="md:w-1/2 mb-4 md:mb-0">
                            <!-- Main Image Display -->
                            <img id="quickview-main-image" src="${firstImage}" alt="${product.name}" class="w-full h-auto rounded-xl object-cover shadow-lg mb-4" onerror="this.onerror=null; this.src='https://placehold.co/600x600/E5E7EB/4B5563?text=Image+Missing';">
                            
                            <!-- Thumbnails/Gallery Controls -->
                            <div class="flex space-x-3 overflow-x-auto pb-2">
                                ${thumbnailsHtml}
                            </div>
                        </div>
                        
                        <!-- Details Column -->
                        <div class="md:w-1/2 flex flex-col justify-between">
                            <div>
                                <h3 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">${product.name}</h3>
                                <span class="text-sm font-medium bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 px-3 py-1 rounded-full">${product.category}</span>
                                <p class="text-4xl font-extrabold text-indigo-600 my-4">$${product.price.toFixed(2)}</p>
                                <p class="text-gray-600 dark:text-gray-300 mb-6">Ultra-soft, sustainable fabric designed for maximum comfort and style. Perfect for everyday wear or your next adventure. Limited stock available in this run.</p>
                            </div>
                            
                            <!-- Action -->
                            <button onclick="addToCart(${product.id}); closeQuickView();" 
                                class="w-full bg-indigo-600 text-white p-4 rounded-xl text-lg font-semibold hover:bg-indigo-700 transition duration-200 flex items-center justify-center space-x-2 shadow-xl transform hover:scale-[1.01]">
                                <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                                <span>Add to Cart</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modalContainer.innerHTML = modalContent;

            document.getElementById('quickview-modal-backdrop').classList.remove('hidden');
            body.classList.add('show-quickview');
            body.classList.add('overflow-hidden');
            lucide.createIcons();
        }

        function closeQuickView() {
            const body = document.getElementById('body-container');
            
            body.classList.remove('show-quickview');
            body.classList.remove('overflow-hidden');

            setTimeout(() => {
                document.getElementById('quickview-modal-backdrop').classList.add('hidden');
            }, 300); 
        }
        
        // --- Filtering, Searching, and Sorting Functionality ---

        /**
         * Applies the current search, category filter, and sort criteria to the product list.
         */
        function applyFilters() {
            const searchInput = document.getElementById('product-search').value.toLowerCase();
            const categorySelect = document.getElementById('category-filter').value;
            const sortCriteria = document.getElementById('sort-by').value;

            let filteredList = [...PRODUCTS];

            // 1. Apply Category Filter
            if (categorySelect !== 'all') {
                filteredList = filteredList.filter(p => p.category === categorySelect);
            }

            // 2. Apply Search Filter
            if (searchInput) {
                filteredList = filteredList.filter(p => 
                    p.name.toLowerCase().includes(searchInput) || 
                    p.category.toLowerCase().includes(searchInput)
                );
            }

            // 3. Apply Sorting
            switch (sortCriteria) {
                case 'low-high':
                    filteredList.sort((a, b) => a.price - b.price);
                    break;
                case 'high-low':
                    filteredList.sort((a, b) => b.price - a.price);
                    break;
                case 'default':
                default:
                    // Reset to original ID order to maintain consistency
                    filteredList.sort((a, b) => a.id - b.id); 
                    break;
            }

            displayedProducts = filteredList;
            renderProducts();
        }


        // --- Initialization ---

        /**
         * Initializes the store application.
         */
        function initStore() {
            initializeDarkMode(); // NEW: Set initial dark mode
            applyFilters(); 
            updateCartCount();
            updateWishlistCount(); // NEW: Update wishlist badge
            renderCart(); 
            renderWishlist(); // NEW: Render wishlist modal content

            // Sticky Header Shadow Listener
            window.addEventListener('scroll', () => {
                const header = document.getElementById('main-header');
                if (window.scrollY > 50) {
                    header.classList.add('header-scrolled');
                } else {
                    header.classList.remove('header-scrolled');
                }
            });
        }

        // Run the initialization function when the page loads
        window.onload = initStore;
    </script>
</body>
</html>
